# Workflow: Deploy to Lovable (Supabase production)
#
# Notes:
# - This workflow runs manually (workflow_dispatch).
# - It requires the Supabase CLI to be available on the runner.
# - Secrets required (add in GitHub repository Settings > Secrets):
#   - LOVABLE_DB_URL  (service_role postgres URL for the Lovable project)
#   - LOVABLE_PROJECT_REF (optional; can be provided as workflow input)
#
name: Deploy to Lovable

on:
  workflow_dispatch:
    inputs:
      project_ref:
        description: 'Supabase project ref (overrides secret LOVABLE_PROJECT_REF)'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_REF: ${{ github.event.inputs.project_ref }}
      DB_URL: ${{ secrets.LOVABLE_DB_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Supabase CLI
        run: |
          set -e
          if command -v supabase >/dev/null 2>&1; then
            echo "supabase already installed"
            exit 0
          fi
          if command -v npm >/dev/null 2>&1; then
            echo "Installing supabase via npm"
            npm install -g supabase
            exit 0
          fi
          echo "npm not found, downloading supabase binary"
          ARCH=$(uname -m)
          OS=$(uname -s)
          URL="https://github.com/supabase/cli/releases/latest/download/supabase_${OS}_${ARCH}.tar.gz"
          echo "Downloading $URL"
          curl -fsSL -o supabase.tar.gz "$URL"
          tar -xzf supabase.tar.gz
          sudo mv supabase /usr/local/bin/supabase
          rm supabase.tar.gz

      - name: Ensure environment
        run: |
          echo "Project ref: '${{ github.event.inputs.project_ref }}'"
          if [ -z "$PROJECT_REF" ]; then
            if [ -n "${{ secrets.LOVABLE_PROJECT_REF }}" ]; then
              export PROJECT_REF="${{ secrets.LOVABLE_PROJECT_REF }}"
            else
              echo "ERROR: Project ref not provided (input or secret LOVABLE_PROJECT_REF)." && exit 1
            fi
          fi
          if [ -z "$DB_URL" ]; then
            echo "ERROR: LOVABLE_DB_URL secret is not set." && exit 1
          fi

      - name: Check supabase CLI
        run: |
          if ! command -v supabase >/dev/null 2>&1; then
            echo "supabase CLI not found on runner. You can either run this on a self-hosted runner with supabase installed, or add an install step to this workflow." && exit 1
          fi

      - name: Link project
        run: supabase link --project-ref "$PROJECT_REF"

      - name: Deploy Edge Functions
        run: |
          for fn in supabase/functions/*; do
            if [ -d "$fn" ]; then
              name=$(basename "$fn")
              echo "Deploying function: $name"
              supabase functions deploy "$name"
            fi
          done

      - name: Apply Migrations
        run: |
          set -e
          for f in supabase/migrations/*.sql; do
            echo "Applying: $f"
            sql=$(cat "$f")
            supabase db query --db-url "$DB_URL" "$sql"
          done

      - name: Done
        run: echo "Deploy finished. Verify on Supabase Dashboard."