name: AutoSync — Build & (optional) Deploy

on:
  push:
    branches: [ main ]
  schedule:
    # every 15 minutes
    - cron: '*/15 * * * *'

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build --if-present

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist

  deploy:
    name: (Optional) Deploy to Lovable
    needs: build
    runs-on: ubuntu-latest
    if: ${{ secrets.LOVABLE_TOKEN && secrets.LOVABLE_SITE_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Notify start
        run: echo "Starting deploy to Lovable for site ${{ secrets.LOVABLE_SITE_ID }}"

      - name: Trigger Lovable deploy (if supported)
        env:
          LOVABLE_TOKEN: ${{ secrets.LOVABLE_TOKEN }}
          LOVABLE_SITE_ID: ${{ secrets.LOVABLE_SITE_ID }}
        run: |
          if [ -z "$LOVABLE_TOKEN" ] || [ -z "$LOVABLE_SITE_ID" ]; then
            echo "Lovable secrets not configured. Skipping deploy.";
            exit 0;
          fi
          # Example API call — replace with actual Lovable deploy API if available
          echo "Calling Lovable API to trigger deploy..."
          curl -s -X POST "https://api.lovable.app/sites/${LOVABLE_SITE_ID}/deploy" \
            -H "Authorization: Bearer ${LOVABLE_TOKEN}" \
            -H 'Content-Type: application/json' \
            -d '{"ref":"main"}' || true
